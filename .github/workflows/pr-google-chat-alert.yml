name: Deploy ## 21

# PR ê´€ë ¨ ì´ë²¤íŠ¸ì™€ ë¦¬ë·° ì œì¶œ ì´ë²¤íŠ¸ë¥¼ ëª¨ë‘ ê°ì§€
on:
  pull_request:
    branches:
      - main
      - develop
    types: [opened, reopened, synchronize, ready_for_review] # ì›ë³¸ ë™ì‘ ìœ ì§€
  pull_request_review:
    types: [submitted] # ë¦¬ë·° ì œì¶œ ì´ë²¤íŠ¸ ì¶”ê°€

jobs:
  # ì›ë˜ PR ê´€ë ¨ ë™ì‘
  notify_pr_event:
    if: github.event_name == 'pull_request' # pull_request ì´ë²¤íŠ¸ì¼ ë•Œë§Œ ì‹¤í–‰
    runs-on: ubuntu-latest

    steps:
      - name: Notify Google Chat on Pull Request
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"
          PR_USER_LOGIN="${{ github.event.pull_request.user.login }}"

          # GitHub Actionsì˜ ì‹œê°„ì€ UTCë¡œ ì œê³µë˜ë¯€ë¡œ, Asia/Seoulë¡œ ë³€í™˜
          CURRENT_TIME_KST=$(TZ="Asia/Seoul" date '+%Y-%m-%d %H:%M:%S')

          curl -X POST \
          -H 'Content-Type: application/json' \
          -d "{\"text\": \"ğŸ¬ [Platform-Monitoring]\n\n${PR_USER_LOGIN} ë‹˜ì´ Pull Request ë¥¼ ìƒì„±í•˜ì˜€ìŠµë‹ˆë‹¤.\n\n- PR ì œëª©: ${PR_TITLE}\n- PR ë‚´ìš©: ${PR_BODY}\n- ì‹œê°: ${CURRENT_TIME_KST}\"}" \
          "${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}"

  # PR ë¦¬ë·° ì•Œë¦¼ ë™ì‘
  notify_review_event:
    if: github.event_name == 'pull_request_review' # pull_request_review ì´ë²¤íŠ¸ì¼ ë•Œë§Œ ì‹¤í–‰
    runs-on: ubuntu-latest

    steps:
      - name: Notify Google Chat on Pull Request Review
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_USER_LOGIN="${{ github.event.pull_request.user.login }}"
          REVIEWER_LOGIN="${{ github.event.review.user.login }}"
          REVIEW_STATE="${{ github.event.review.state }}"
          REVIEW_BODY="${{ github.event.review.body }}"

          # GitHub Actionsì˜ ì‹œê°„ì€ UTCë¡œ ì œê³µë˜ë¯€ë¡œ, Asia/Seoulë¡œ ë³€í™˜
          CURRENT_TIME_KST=$(TZ="Asia/Seoul" date '+%Y-%m-%d %H:%M:%S')

          curl -X POST \
          -H 'Content-Type: application/json' \
          -d "{\"text\": \"ğŸ¬ [Platform-Monitoring]\n\n${REVIEWER_LOGIN} ë‹˜ì´ Pull Request ì— ë¦¬ë·°ë¥¼ ì œì¶œí•˜ì˜€ìŠµë‹ˆë‹¤.\n\n- PR ì œëª©: ${PR_TITLE}\n- ë¦¬ë·° ìƒíƒœ: ${REVIEW_STATE}\n- ë¦¬ë·° ë‚´ìš©: ${REVIEW_BODY}\n- ì‹œê°: ${CURRENT_TIME_KST}\"}" \
          "${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}"
